# Система разрешений
 
1. [Обзор проекта](/docs/1.OVERVIEW.md)
2. [Реплики](/docs/2.REPLICAS.md)
3. Система разрешений
4. [Разработка реплик](/docs/4.DEVELOPMENT.md)
5. [Каталог реплик](/replicas/README.md)

---

В Reside реализована хитрая система разрешений, позволяющая репликам безопасно взаимодействовать друг с другом и с данными в Jazz.

## Аккаунты в Jazz

Сначала стоит сказать несколько слов про аккаунты в Jazz.
И про безопасность в целом.

В Jazz 100% всех объектов создается тем или иным аккаунтом.
И по умолчанию, каждый созданный объект доступен только тому аккаунту, который его создал.
Это ограничение криптографическое - данные зашифрованы и расшифровать их может только владелец аккаунта.
Соответственно, аутентификация в Jazz тоже криптографическая и сводится к наличию приватного ключа аккаунта.

В Jazz также есть группы.
Строго говоря, когда аккаунт создает объект, то его владелец это не сам аккаунт,
а новая группа, содержащая только этот аккаунт.
В дальнейшем владелец объекта может добавлять в эту группу других аккаунтов, чтобы предоставить им доступ к объекту.
Необязательно создавать отдельную группу для каждого объекта - можно использовать одну группу для нескольких объектов.

Соответственно, когда один из уполномоченных аккаунтов добавляет в группу новый аккаунт (или другую группу),
он выполняет ротацию ключей и рассылает новые ключи всем остальным участникам группы. Аналогично происходит и при удалении участников из группы.

Очевидный плюс такого подхода в том, что мы можем быть на 100% уверены, что по умолчанию никто, кроме владельца объекта, не имеет к нему доступа.
С другой стороны, управление доступом местами становится сложнее, особенно когда объектов много, а группы пересекаются.

## RCB

Подразумевается, что каждая реплика монопольно владеет своим аккаунтом в Jazz (хотя на практике это не совсем так, ведь никто не запрещает просто достать ее приватный ключ из соответствующего секрета в Kubernetes).
И, как уже было сказано, только владелец аккаунта может выдать другим аккаунтам доступ к данным.
Получается, что только сама реплика может выдать доступ и для этого она должна откуда-то знать, что и кому выдавать. Именно эта информация и хранится в RCB.

В RCB отслеживается список разрешений, которые реплика выдала или должна выдать другим аккаунтам (причем не только репликам, но и любым другим аккаунтам в Jazz).
Как они туда попадают - оставим пока что за скобками.
Как уже было сказано, реплика также имеет доступ на запись в свой RCB,
чтобы иметь возможность отмечать какие разрешения уже выданы или отозваны.

Процесс выдачи доступов и обновления RCB реализован в функции [`reconcileControlBlockPermissions`](/packages/shared/src/permissions.ts) и в фоне выполняется репликой при старте, а также при любом изменении RCB.

## Контракты

Каждый контракт определяет набор разрешений, которые могут быть запрошены потребителями контракта.
Но вместе с этим он также объявляет и обработчики, которые реплика будет вызывать, чтобы выдать или отозвать запрошенные разрешения.

Доступны следующие обработчики:

- `onGranted` - вызывается для каждого разрешения, когда реплика впервые выдает его другому аккаунту;
- `onRevoked` - вызывается для каждого разрешения, когда реплика отзывает его у другого аккаунта;
- `onUpdated` - вызывается для каждого разрешения, когда реплика должна обновить его (когда изменились его параметры).

Каждое разрешение в контракте имеет уникальное имя в пределах контракта.
Соответственно, глобально уникальное имя разрешения формируется как комбинация identity контракта и имени разрешения в нем.

Каждое разрешение также может содержать параметры, которые будут переданы обработчикам.
Например, разрешение для чтения некоторого объекта в Jazz может принимать в качестве параметра его ID,
а разрешения для доступа в интернет - список разрешенных доменов.

Каждое объявленное в контракте разрешение может также быть выдано в нескольких экземплярах с разными параметрами.
Для этого контракт может объявить функцию `getInstanceId` для разрешения, которая будет использоваться для генерации детерминированного ID экземпляра разрешения на основе его параметров.
Таким образом, сам контракт определяет какие параметры разрешения влияют на его уникальность.

Экземпляры разрешений делятся на три типа:

- `static` - статические разрешения, которые указаны в манифесте реплики и выдаются при ее загрузке в кластер;
- `dynamic` - динамические разрешения, которые запрашиваются репликой в процессе работы (на данный момент это не реализовано);
- `manual` - разрешения, добавленные вручную администратором кластера для произвольного аккаунта в Jazz.

Дальнейшее изучение системы стоит продолжить с чтения документации каждой конкретной реплики,
найти которых можно в [каталоге реплик](/replicas/README.md).
