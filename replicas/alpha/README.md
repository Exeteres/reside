# Альфа-Реплика

[Назад к списку реплик](/replicas/README.md)

<table>
<tr>
<td valign="top">

Альфа-Реплика появляется сразу после [Первоначальной Реплики](/replicas/seed/README.md) и остается в кластере на протяжении всего его жизненного цикла.
Она отвечает за создание новых реплик, следит за состоянием их Kubernetes-ресурсов и выдает им необходимые разрешения.

</td>
<td>

<img width="300" src="REPLICA.png" alt="Alpha Replica"/>
</td>
</tr>

</table>

## Экземпляры и версии реплик

Стоит явно разделять три понятия:

- реплика;
- экземпляр реплики;
- версия реплики.

Первые два понятия часто смешиваются ради удобства (а еще потому что реплики одушевлены), но на самом деле это разные вещи. Первое понятие - это реплика как сущность исходного кода, который лежит в папке `replicas`, а также соответствующий ей Docker-образ. Второе понятие - это экземпляр реплики, то есть конкретная реплика, развернутая в конкретном кластере. Если реплика не [эксклюзивная](/docs//2.REPLICAS.md#реплики-1), то в одном кластере может быть несколько ее экземпляров.

Версия реплики - это уже отдельная полноценная сущность, отслеживаемая Альфа-Репликой. Каждый экземпляр реплики может иметь несколько версий, которые создаются при каждом обновлении этого экземпляра. На самом деле, при загрузке новой реплики, сначала создается ее версия, а уже затем сама реплика, если она еще не была создана. В каждый момент времени у экземпляра реплики есть только одна активная версия, но все предыдущие версии сохраняются для истории и отката (который не реализован).

Однако, если реплика является масштабируемой (`scalable`), то при ее обновлении следующая версия запускается параллельно с предыдущей. Предыдущая же версия не останавливается до тех пор, пока новая версия не пройдет хелсчеки. Если `scalable` равно `false`, то предыдущая версия останавливается до запуска новой версии. В нормальном же режиме работы у реплики всегда запущена только одна версия, так что параметр `scalable` немного вводит в заблуждение: на самом деле он означает "может ли реплика переключаться между версиями без простоя".

## Запросы на загрузку

Запрос на загрузку (Load Request) - это сущность, которая инициирует создание новой версии реплики (а также самой реплики). Минимально, для загрузки реплики нужно указать только имя ее докер-образа. Причем, это не обязательно должен быть ее identity, он может указывать тег или хеш образа. Затем Альфа-Реплика загружает образ, извлекает из него манифест и создает новую версию реплики на его основе. Если реплика эксклюзивная, то при повторной загрузке образа той же реплики, Альфа-Реплика просто обновляет существующую реплику. В противном случае, для обновления существующей реплики нужно явно указать ее ID в запросе на загрузку.

## RCB

Ранее уже неоднократно упоминался [RCB](/docs/2.REPLICAS.md#rcb) - специальный объект, который содержит в себе всю информацию о реплике, необходимую для ее запуска и работы. Также этот RCB [отслеживает](/docs/3.PERMISSIONS.md#rcb) какие разрешения реплика выдала или должна выдать другим аккаунтам в Jazz.

Альфа-Реплика отвечает за создание RCB для новых реплик. Всех, за исключением RCB самой Альфа-Реплики и [Кубовой Реплики](/replicas/kubernetes-sentinel/README.md), которые создаются Первоначальной Репликой.

Она также отвечает за обновление RCB, в том числе, за синхронизацию списка разрешений в RCB с реальным состоянием выданных разрешений.

Стоит отметить, что Альфа-Реплика не единственная реплика в кластере, которая может изменять RCB других реплик. Еще этим занимается [Пользовательская Реплика](/replicas/user-manager/README.md), которая использует RCB для выдачи разрешений реплик реальным пользователям. Да, абсолютно любые разрешения, которые выдаются репликам, точно также могут быть выданы и простым пользователям. Для управления RCB предусмотрено специальное разрешение `rcb:manage:all`, которое и использует Пользовательская Реплика.

## Создание и отслеживание ресурсов в Kubernetes

Альфа-Реплика также отвечает за создание всех необходимых Kubernetes-ресурсов для новых реплик. В их число входят:

- Секреты с учетными данными Jazz аккаунта
- Деплойметы для `long-running` реплик и Джобы для `oneshot` реплик
- Сервисы для реплик, которые реализует как минимум один RPC-метод
- Ingress-ресурсы для реплик, у которых есть сервис

Альфа-Реплика следит за наличием всех этих ресурсов и при необходимости восстанавливает их, если они были удалены или изменены вручную. Она регистрирует Kubernetes-ресурсы в коллекциях Кубовой Реплики, которая затем применяет их в кластере и отслеживает их состояние.

Альфа-Реплика также отслеживает состояние деплойментов и джоб и обновляет их поле `status` в объекте соответствующей версии реплики.
