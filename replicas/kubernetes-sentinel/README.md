# Кубовая Реплика

[Назад к списку реплик](/replicas/README.md)

<table>
<tr>
<td valign="top">

Эта реплика появляется сразу после [Первоначальной Реплики](../seed/README.md) и остается в кластере на протяжении всего его жизненного цикла.
Она отслеживает желания других реплик относительно ресурсов Kubernetes и приводит текущее состояние кластера в соответствие с этими желаниями.
Она также собирает информацию о состоянии ресурсов и предоставляет её другим репликам в реальном времени.

</td>
<td>

<img width="300" src="REPLICA.png" alt="Kubernetes Sentinel Replica"/>

</td>
</tr>
</table>

## Принцип работы

Кубовая Реплика реализует паттерн "desired state reconciliation": другие реплики декларируют желаемое состояние Kubernetes-ресурсов, а Кубовая Реплика приводит реальное состояние кластера в соответствие с желаемым.

Она работает по следующему циклу:

1. Отслеживает изменения в коллекциях `ManagedObject`;
2. При изменении статуса на `requested` применяет желаемый манифест в Kubernetes;
3. Обновляет статус на `updated` или `error` в зависимости от результата;
4. Непрерывно синхронизирует поле `live` с реальным состоянием ресурса в кластере;
5. Удаляет ресурсы, которые больше не присутствуют в коллекциях.

## API Реплики

API данной реплики представляет собой набор коллекций объектов, т.н. `ManagedObject`, каждый из которых соответствует ресурсу Kubernetes.

Каждый `ManagedObject` содержит:

- **name**: Имя ресурса Kubernetes
- **status**: Статус синхронизации ресурса (`requested`, `updated`, `error`)
- **manifest**: Желаемый манифест ресурса в виде объекта 
- **live**: Наблюдаемый манифест ресурса

Каждая коллекция `ManagedObject` соответствует определенному типу ресурса Kubernetes.

Типичный флоу работы с этой репликой со стороны потребителя:

1. Создать/обновить `ManagedObject` с желаемым манифестом ресурса;
2. Перевести его статус в `requested`, чтобы стриггерить Кубовую Реплику;
3. (опционально) Дождаться обновления статуса до `updated` или `error`;
4. Читать поле `live` для получения текущего состояния ресурса.

Поскольку сами коллекции представляют собой объекты Jazz и хранятся на сервере синхронизации, отказ Кубовой Реплики не приводит к ошибкам у потребителей, а также потери желаемых манифестов. Просто они не будут применены до восстановления реплики, а текущее состояние ресурсов не будет обновляться.

Самым очевидным потребителем этой реплики является [Альфа-Реплика](/replicas/alpha/README.md), которая использует её для развертывания других реплик.

## Поддерживаемые типы ресурсов

Кубовая Реплика поддерживает следующие типы Kubernetes-ресурсов:

- **Workloads**: `Deployment`, `StatefulSet`, `Job`
- **Configuration**: `Secret`, `ConfigMap`
- **Networking**: `Service`, `Ingress`, `NetworkPolicy`
- **Storage**: `PersistentVolumeClaim`
- **RBAC**: `ServiceAccount`, `Role`, `RoleBinding`

Для каждого типа ресурса существует своя коллекция в контракте Кубовой Реплики, например:
- `deployments` для `Deployment`
- `secrets` для `Secret`
- `services` для `Service`

## Разрешения

Для работы с каждым типом ресурсов требуются соответствующие разрешения:

- `{resource}:read:all` - чтение всех ресурсов данного типа
- `{resource}:manage:all` - создание, обновление и удаление ресурсов данного типа

Например:
- `deployments:read:all` - чтение всех Deployment'ов
- `deployments:manage:all` - управление Deployment'ами
- `secrets:read:all` - чтение всех Secret'ов
- `secrets:manage:all` - управление Secret'ами

## Безопасность

Кубовая Реплика - единственная реплика в кластере, имеющая прямой доступ к Kubernetes API. Все остальные реплики взаимодействуют с Kubernetes только через неё, что позволяет:

- Централизованно контролировать доступ к Kubernetes;
- Использовать минимальные RBAC-права для других реплик;
- Отслеживать все изменения в кластере через единую точку входа;
- В будущем применять Network Policies для изоляции реплик.
