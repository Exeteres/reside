# Пользовательская Реплика

[Назад к списку реплик](/replicas/README.md)

<table>
<tr>
<td valign="top">

Управляет аккаунтами реальных пользователей и позволяет выдавать им разрешения для доступа к другим репликам.

</td>
<td>

<img width="300" src="REPLICA.png" alt="User Manager Replica"/>

</td>
</tr>
</table>

## Пользователи

Пользователь (User) - это сущность, отслеживаемая Пользовательской Репликой, которая представляет учетную запись реального человека. Хотя, чисто теоретически, пользователь может быть и не человеком. В каждой такой сущности есть ссылка на Jazz аккаунт, который используется для аутентификации пользователя.

Пользователи бывают двух типов: `управляемые` и `неуправляемые`. Управляемые пользователи создаются самой Пользовательской Репликой, ей же создается соответствующий Jazz аккаунт и сохранется его приватный ключ. Неуправляемые пользователи создают Jazz аккаунт самостоятельно и регистрируются в Пользовательской Реплике. Они управляют своим приватным ключом самостоятельно.

## Имперсонация

Управляемые пользователи могут быть имперсонированы, т.е. их какая-то другая реплика может авторизоваться от их имени и выполнять действия от их лица с их разрешениями. Для этого другая реплика должна получить разрешение `user:impersonate:realm:{realName}`, где `{realmName}` - это имя реалма, пользователей которого она сможет имперсонировать.

## Реалмы

Чтобы разграничить возможности реплик по имперсонации, все пользователи разбиты на реалмы (realms). Реалм определяется при регистрации неуправляемого пользователя или при создании управляемого и не может быть изменен. Все неуправляемые пользователи регистрируются в реалме `default`, а управляемые пользователи создаются в реалме, для которого у создающей реплики есть разрешение `user:create:realm:{realmName}`.

Одним из главных потребителей реалмов и имперсонации является [Телеграмная Реплика](/replicas/telegram/README.md), которая создает в реалме `telegram` управляемых пользователей для каждого взаимодействующего с ней Telegram-пользователя.
Затем реплики, такие как [Секретарь Альфа-Реплики](/replicas/alpha-secretary/README.md), могут имперсонировать этих пользователей для выполнения действий от их лица в других репликах.

У такого подхода есть два главных преимущества:

- Репликам вроде секретарей не нужно запрашивать широкий спектр разрешений для себя, чтобы выполнять действия от лица пользователей. Вместо этого они получают узкоспециализированные разрешения на имперсонацию конкретных реалмов.
- Репликам необязательно самостоятельно проверять разрешения пользователей. Если у имперсонированного пользователя нет нужного разрешения, то действие упадет с ошибкой. Впрочем, реплика может дополнительно проверять разрешения, чтобы показать пользователю более информативное сообщение, но это уже вопрос удобства, а не безопасности. 
    
## RCB

По аналогии с [Альфа-Репликой](/replicas/alpha/README.md#rcb), Пользовательская Реплика также использует RCB для хранения информации о выданных разрешениях. Однако, в отличие от Альфа-Реплики, которая выдает разрешения другим репликам, Пользовательская Реплика выдает разрешения реальным пользователям. Для этого она использует разрешение `rcb:manage:all`, которое позволяет ей изменять RCB любых реплик.
